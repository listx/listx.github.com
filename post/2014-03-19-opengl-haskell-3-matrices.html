<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>Linus's Blog - OpenGL from Haskell (#3: Matrices)</title>
		<link rel="stylesheet" href="../css/base.css">
		<link rel="stylesheet" href="../css/syntax.css">
		<link href="https://fonts.googleapis.com/css?family=Merriweather:300,300italic,700italic,700" rel="stylesheet" type="text/css">
		<link rel="shortcut icon" type="image/png" href="../favicon.png">
		<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
		<script src="../misc.js"></script>
		<!-- https://github.com/mreid/markreidname-hakyll/blob/master/_templates/mathjax.html -->
<script type="text/x-mathjax-config">
	MathJax.Hub.Config({
		extensions: ["tex2jax.js"],
		jax: ["input/TeX", "output/HTML-CSS"],
		tex2jax: {
			inlineMath: [ ["\\(","\\)"] ],
			displayMath: [ ["\\[","\\]"] ],
			processEscapes: true
		},
		TeX: { equationNumbers: { autoNumber: "AMS" } },
		"HTML-CSS": { availableFonts: ["TeX"] }
	});
</script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"> </script>

	</head>
	<body>
		<div id="header">
			<a href="../">Blog</a>
			&bull;
			<a href="../about.html">About</a>
			&bull;
			<a href="../code.html">Code</a>
			&bull;
			<a href="../papers.html">Papers</a>
		</div>

		<div id="content">
			<h1 class="center" id="page-title">OpenGL from Haskell (#3: Matrices)</h1>

			<div class="info center">
	<code class="date">2014-03-19</code><a class="history" href="https://github.com/listx/listx_blog/commits/master/post/2014-03-19-opengl-haskell-3-matrices.md" title="History">*</a>
	<br>
	<a href="../tag/haskell.html">haskell</a>, <a href="../tag/opengl.html">opengl</a>
</div>

<p>The following is my translation/adaptation of <a href="http://www.opengl-tutorial.org/beginners-tutorials/tutorial-3-matrices/">tutorial #2</a> at <a href="http://www.opengl-tutorial.org" class="uri">http://www.opengl-tutorial.org</a>. My <a href="2014-03-15-opengl-from-haskell.html">last post</a> was a translation of tutorial #2, which dealt with triangles — this is the reason why this post’s title is called “#3: Matrices”. The end result of this tutorial is a 3D triangle with 3 different colored vertices that are interpolated smoothly by OpenGL.</p>
<p>My version again uses the code from <a href="https://github.com/YPares/Haskell-OpenGL3.1-Tutos" class="uri">https://github.com/YPares/Haskell-OpenGL3.1-Tutos</a>. The <code>Data.Vec</code> import is for the <a href="http://hackage.haskell.org/package/Vec">Vec</a> package. Like my last post, my code here does does not use <code>Control.Applicative</code> puts everything, including the GLSL shaders directly into the code. The <code>RankNTypes</code> and <code>TypeOperators</code> GHC extensions are only there to suppress warnings from using <code>ghc --make -Wall</code>; if you don’t want to use these extensions, just remove the type signature for the <code>vec3</code> function near the bottom.</p>
<p>I have also removed the use of backticks for Haskell’s infix notation (<code>`...`</code>). It’s not because I like using parentheses — I just don’t like using infix notation because it runs against the argument handling order of normal functions found everywhere else.</p>
<p>Also, I have fixed YPares’s original <code>lookAt</code> function which is actually <a href="https://github.com/YPares/Haskell-OpenGL3.1-Tutos/commit/7a027b927d061fbd26138cb7357c40c4cacbc927">broken as of commit 7a027b927d061fbd26138cb7357c40c4cacbc927</a>; you will need my version if you wish to pursue the later tutorials that actually test the validity of this function, such as the keyboard/mouse input tutorial #6 from <a href="http://www.opengl-tutorial.org" class="uri">http://www.opengl-tutorial.org</a>.</p>
<p>The code here is released into the Public Domain.</p>
<div class="code-and-raw lineCntMax1000">
<div class="raw-link sourceCode">
<table class="sourceCode numberLines noPaddingBottom"><tbody><tr class="sourceCode"><td class="lineNumbers"><pre>&nbsp;&nbsp;■</pre></td><td class="sourceCode"><pre><code><a class="raw" href="../code/opengl/matrices.hs" mimetype="text/plain">matrices.hs</a></code></pre></td></tr></tbody></table>
</div>
<div class="sourceCode" id="cb1" data-input="code/opengl/matrices.hs"><pre class="sourceCode numberSource numberLines haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb1-1" title="1"><span class="ot">{-# LANGUAGE PackageImports #-}</span></a>
<a class="sourceLine" id="cb1-2" title="2"><span class="ot">{-# LANGUAGE RecordWildCards #-}</span></a>
<a class="sourceLine" id="cb1-3" title="3"><span class="ot">{-# LANGUAGE RankNTypes #-}</span></a>
<a class="sourceLine" id="cb1-4" title="4"><span class="ot">{-# LANGUAGE TypeOperators #-}</span></a>
<a class="sourceLine" id="cb1-5" title="5"><span class="kw">module</span> <span class="dt">Main</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb1-6" title="6"></a>
<a class="sourceLine" id="cb1-7" title="7"><span class="kw">import</span> <span class="dt">Control.Monad</span></a>
<a class="sourceLine" id="cb1-8" title="8"><span class="kw">import</span> <span class="dt">Data.Maybe</span></a>
<a class="sourceLine" id="cb1-9" title="9"><span class="kw">import</span> <span class="dt">Data.Vec</span></a>
<a class="sourceLine" id="cb1-10" title="10"><span class="kw">import</span> <span class="dt">Foreign</span></a>
<a class="sourceLine" id="cb1-11" title="11"><span class="kw">import</span> <span class="dt">Foreign.C.String</span></a>
<a class="sourceLine" id="cb1-12" title="12"><span class="kw">import</span> <span class="dt">Foreign.C.Types</span></a>
<a class="sourceLine" id="cb1-13" title="13"><span class="kw">import</span> <span class="kw">qualified</span> &quot;<span class="dt">GLFW</span>-b&quot; <span class="dt">Graphics.UI.GLFW</span> <span class="kw">as</span> <span class="dt">GLFW</span></a>
<a class="sourceLine" id="cb1-14" title="14"><span class="kw">import</span> <span class="dt">Graphics.Rendering.OpenGL.Raw</span></a>
<a class="sourceLine" id="cb1-15" title="15"><span class="kw">import</span> <span class="dt">System.Exit</span></a>
<a class="sourceLine" id="cb1-16" title="16"></a>
<a class="sourceLine" id="cb1-17" title="17"><span class="kw">data</span> <span class="dt">GLIDs</span> <span class="fu">=</span> <span class="dt">GLIDs</span></a>
<a class="sourceLine" id="cb1-18" title="18">  {<span class="ot"> progId ::</span> <span class="fu">!</span><span class="dt">GLuint</span></a>
<a class="sourceLine" id="cb1-19" title="19">  ,<span class="ot"> vertexArrayId ::</span> <span class="fu">!</span><span class="dt">GLuint</span></a>
<a class="sourceLine" id="cb1-20" title="20">  ,<span class="ot"> vertexAttrib ::</span> <span class="fu">!</span><span class="dt">GLuint</span></a>
<a class="sourceLine" id="cb1-21" title="21">  ,<span class="ot"> vertexBufferId ::</span> <span class="fu">!</span><span class="dt">GLuint</span></a>
<a class="sourceLine" id="cb1-22" title="22">  ,<span class="ot"> colorAttrib ::</span> <span class="fu">!</span><span class="dt">GLuint</span></a>
<a class="sourceLine" id="cb1-23" title="23">  ,<span class="ot"> colorBufferId ::</span> <span class="fu">!</span><span class="dt">GLuint</span></a>
<a class="sourceLine" id="cb1-24" title="24">  ,<span class="ot"> mvpMatrixUniform ::</span> <span class="fu">!</span><span class="dt">GLint</span></a>
<a class="sourceLine" id="cb1-25" title="25">  }</a>
<a class="sourceLine" id="cb1-26" title="26"></a>
<a class="sourceLine" id="cb1-27" title="27"><span class="ot">withNewPtr ::</span> <span class="dt">Storable</span> b <span class="ot">=&gt;</span> (<span class="dt">Ptr</span> b <span class="ot">-&gt;</span> <span class="dt">IO</span> a) <span class="ot">-&gt;</span> <span class="dt">IO</span> b</a>
<a class="sourceLine" id="cb1-28" title="28">withNewPtr f <span class="fu">=</span> alloca (\p <span class="ot">-&gt;</span> f p <span class="fu">&gt;&gt;</span> peek p)</a>
<a class="sourceLine" id="cb1-29" title="29"></a>
<a class="sourceLine" id="cb1-30" title="30"><span class="ot">initialize ::</span> <span class="dt">IO</span> <span class="dt">GLFW.Window</span></a>
<a class="sourceLine" id="cb1-31" title="31">initialize <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-32" title="32">  ok <span class="ot">&lt;-</span> GLFW.init</a>
<a class="sourceLine" id="cb1-33" title="33">  when (<span class="fu">not</span> ok) <span class="fu">$</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-34" title="34">    _ <span class="ot">&lt;-</span> <span class="fu">fail</span> <span class="st">&quot;Failed to initialize GLFW&quot;</span></a>
<a class="sourceLine" id="cb1-35" title="35">    exitFailure</a>
<a class="sourceLine" id="cb1-36" title="36">  <span class="fu">mapM_</span> GLFW.windowHint</a>
<a class="sourceLine" id="cb1-37" title="37">    [ <span class="dt">GLFW.WindowHint'Samples</span> <span class="dv">4</span> <span class="co">-- 4x antialiasing</span></a>
<a class="sourceLine" id="cb1-38" title="38">    , <span class="dt">GLFW.WindowHint'ContextVersionMajor</span> <span class="dv">3</span> <span class="co">-- OpenGL 3.3</span></a>
<a class="sourceLine" id="cb1-39" title="39">    , <span class="dt">GLFW.WindowHint'ContextVersionMinor</span> <span class="dv">3</span></a>
<a class="sourceLine" id="cb1-40" title="40">    , <span class="dt">GLFW.WindowHint'OpenGLProfile</span> <span class="dt">GLFW.OpenGLProfile'Core</span></a>
<a class="sourceLine" id="cb1-41" title="41">    ]</a>
<a class="sourceLine" id="cb1-42" title="42"></a>
<a class="sourceLine" id="cb1-43" title="43">  win <span class="ot">&lt;-</span> GLFW.createWindow <span class="dv">800</span> <span class="dv">600</span> <span class="st">&quot;Window Title&quot;</span> <span class="dt">Nothing</span> <span class="dt">Nothing</span></a>
<a class="sourceLine" id="cb1-44" title="44">  when (isNothing win) <span class="fu">$</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-45" title="45">    _ <span class="ot">&lt;-</span> <span class="fu">fail</span> <span class="st">&quot;Failed to create OpenGL window&quot;</span></a>
<a class="sourceLine" id="cb1-46" title="46">    GLFW.terminate</a>
<a class="sourceLine" id="cb1-47" title="47">    exitFailure</a>
<a class="sourceLine" id="cb1-48" title="48">  <span class="kw">let</span></a>
<a class="sourceLine" id="cb1-49" title="49">    win' <span class="fu">=</span> fromJust win</a>
<a class="sourceLine" id="cb1-50" title="50">  GLFW.makeContextCurrent win</a>
<a class="sourceLine" id="cb1-51" title="51">  GLFW.setStickyKeysInputMode win' <span class="dt">GLFW.StickyKeysInputMode'Enabled</span></a>
<a class="sourceLine" id="cb1-52" title="52">  <span class="fu">return</span> win'</a>
<a class="sourceLine" id="cb1-53" title="53"></a>
<a class="sourceLine" id="cb1-54" title="54"><span class="ot">initializeGL ::</span> <span class="dt">IO</span> <span class="dt">GLIDs</span></a>
<a class="sourceLine" id="cb1-55" title="55">initializeGL <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-56" title="56">  glClearColor <span class="dv">0</span> <span class="dv">0</span> <span class="fl">0.4</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb1-57" title="57">  progId <span class="ot">&lt;-</span> loadProgram</a>
<a class="sourceLine" id="cb1-58" title="58">    (<span class="st">&quot;vertexShader2&quot;</span>, vertexShader2)</a>
<a class="sourceLine" id="cb1-59" title="59">    (<span class="st">&quot;fragmentShader2&quot;</span>, fragmentShader2)</a>
<a class="sourceLine" id="cb1-60" title="60">  v <span class="ot">&lt;-</span> withCString <span class="st">&quot;vertexPosition_modelspace&quot;</span></a>
<a class="sourceLine" id="cb1-61" title="61">    <span class="fu">$</span> glGetAttribLocation progId</a>
<a class="sourceLine" id="cb1-62" title="62">  c <span class="ot">&lt;-</span> withCString <span class="st">&quot;vertexColor&quot;</span> <span class="fu">$</span> glGetAttribLocation progId</a>
<a class="sourceLine" id="cb1-63" title="63">  m <span class="ot">&lt;-</span> withCString <span class="st">&quot;MVP&quot;</span> <span class="fu">$</span> glGetUniformLocation progId</a>
<a class="sourceLine" id="cb1-64" title="64">  vertexAttrib <span class="ot">&lt;-</span> findAttribUniform v <span class="st">&quot;vertexPosition_modelspace&quot;</span></a>
<a class="sourceLine" id="cb1-65" title="65">  colorAttrib <span class="ot">&lt;-</span> findAttribUniform c <span class="st">&quot;vertexColor&quot;</span></a>
<a class="sourceLine" id="cb1-66" title="66">  mvpMatrixUniform <span class="ot">&lt;-</span> findAttribUniform m <span class="st">&quot;MVP&quot;</span></a>
<a class="sourceLine" id="cb1-67" title="67">  vertexArrayId <span class="ot">&lt;-</span> newVAO</a>
<a class="sourceLine" id="cb1-68" title="68">  vertexBufferId <span class="ot">&lt;-</span> fillNewBuffer vertexBufferData</a>
<a class="sourceLine" id="cb1-69" title="69">  colorBufferId <span class="ot">&lt;-</span> fillNewBuffer colorBufferData</a>
<a class="sourceLine" id="cb1-70" title="70">  <span class="fu">return</span> <span class="dt">GLIDs</span>{<span class="fu">..</span>}</a>
<a class="sourceLine" id="cb1-71" title="71">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb1-72" title="72"><span class="ot">  vertexBufferData ::</span> [<span class="dt">GLfloat</span>]</a>
<a class="sourceLine" id="cb1-73" title="73">  vertexBufferData <span class="fu">=</span></a>
<a class="sourceLine" id="cb1-74" title="74">    <span class="co">-- x, y, z</span></a>
<a class="sourceLine" id="cb1-75" title="75">    [ <span class="fu">-</span><span class="dv">1</span>, <span class="fu">-</span><span class="dv">1</span>, <span class="dv">0</span></a>
<a class="sourceLine" id="cb1-76" title="76">    ,  <span class="dv">1</span>, <span class="fu">-</span><span class="dv">1</span>, <span class="dv">0</span></a>
<a class="sourceLine" id="cb1-77" title="77">    ,  <span class="dv">0</span>,  <span class="dv">1</span>, <span class="dv">0</span></a>
<a class="sourceLine" id="cb1-78" title="78">    ]</a>
<a class="sourceLine" id="cb1-79" title="79"><span class="ot">  colorBufferData ::</span> [<span class="dt">GLfloat</span>]</a>
<a class="sourceLine" id="cb1-80" title="80">  colorBufferData <span class="fu">=</span></a>
<a class="sourceLine" id="cb1-81" title="81">    [ <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span></a>
<a class="sourceLine" id="cb1-82" title="82">    , <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span></a>
<a class="sourceLine" id="cb1-83" title="83">    , <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span></a>
<a class="sourceLine" id="cb1-84" title="84">    ]</a>
<a class="sourceLine" id="cb1-85" title="85">  findAttribUniform x name <span class="fu">=</span> <span class="kw">if</span> x <span class="fu">&lt;</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb1-86" title="86">    <span class="kw">then</span> <span class="fu">error</span> <span class="fu">$</span> <span class="st">&quot;`&quot;</span> <span class="fu">++</span> name <span class="fu">++</span> <span class="st">&quot;' cannot be found!&quot;</span></a>
<a class="sourceLine" id="cb1-87" title="87">    <span class="kw">else</span> <span class="fu">return</span> <span class="fu">$</span> <span class="fu">fromIntegral</span> x</a>
<a class="sourceLine" id="cb1-88" title="88"></a>
<a class="sourceLine" id="cb1-89" title="89"><span class="ot">freeResources ::</span> <span class="dt">GLIDs</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb1-90" title="90">freeResources <span class="dt">GLIDs</span>{<span class="fu">..</span>} <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-91" title="91">  with vertexBufferId <span class="fu">$</span> glDeleteBuffers <span class="dv">1</span></a>
<a class="sourceLine" id="cb1-92" title="92">  with colorBufferId <span class="fu">$</span> glDeleteBuffers <span class="dv">1</span></a>
<a class="sourceLine" id="cb1-93" title="93">  with vertexArrayId <span class="fu">$</span> glDeleteVertexArrays <span class="dv">1</span></a>
<a class="sourceLine" id="cb1-94" title="94"></a>
<a class="sourceLine" id="cb1-95" title="95"><span class="ot">newVAO ::</span> <span class="dt">IO</span> <span class="dt">GLuint</span></a>
<a class="sourceLine" id="cb1-96" title="96">newVAO <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-97" title="97">  vaId <span class="ot">&lt;-</span> withNewPtr (glGenVertexArrays <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb1-98" title="98">  glBindVertexArray vaId</a>
<a class="sourceLine" id="cb1-99" title="99">  <span class="fu">return</span> vaId</a>
<a class="sourceLine" id="cb1-100" title="100"></a>
<a class="sourceLine" id="cb1-101" title="101"><span class="ot">fillNewBuffer ::</span> [<span class="dt">GLfloat</span>] <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">GLuint</span></a>
<a class="sourceLine" id="cb1-102" title="102">fillNewBuffer xs <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-103" title="103">  bufId <span class="ot">&lt;-</span> withNewPtr (glGenBuffers <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb1-104" title="104">  glBindBuffer gl_ARRAY_BUFFER bufId</a>
<a class="sourceLine" id="cb1-105" title="105">  withArrayLen xs func <span class="co">-- give given vertices to OpenGL</span></a>
<a class="sourceLine" id="cb1-106" title="106">  <span class="fu">return</span> bufId</a>
<a class="sourceLine" id="cb1-107" title="107">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb1-108" title="108">  func len ptr <span class="fu">=</span> glBufferData</a>
<a class="sourceLine" id="cb1-109" title="109">    gl_ARRAY_BUFFER</a>
<a class="sourceLine" id="cb1-110" title="110">    (<span class="fu">fromIntegral</span> (len <span class="fu">*</span> sizeOf (<span class="fu">undefined</span><span class="ot"> ::</span> <span class="dt">GLfloat</span>)))</a>
<a class="sourceLine" id="cb1-111" title="111">    (<span class="ot">ptr ::</span> <span class="dt">Ptr</span> <span class="dt">GLfloat</span>)</a>
<a class="sourceLine" id="cb1-112" title="112">    gl_STATIC_DRAW</a>
<a class="sourceLine" id="cb1-113" title="113"></a>
<a class="sourceLine" id="cb1-114" title="114"><span class="ot">bindBufferToAttrib ::</span> <span class="dt">GLuint</span> <span class="ot">-&gt;</span> <span class="dt">GLuint</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb1-115" title="115">bindBufferToAttrib bufId attribLoc <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-116" title="116">  glEnableVertexAttribArray attribLoc</a>
<a class="sourceLine" id="cb1-117" title="117">  glBindBuffer gl_ARRAY_BUFFER bufId</a>
<a class="sourceLine" id="cb1-118" title="118">  glVertexAttribPointer</a>
<a class="sourceLine" id="cb1-119" title="119">    attribLoc <span class="co">-- attribute location in the shader</span></a>
<a class="sourceLine" id="cb1-120" title="120">    <span class="dv">3</span> <span class="co">-- 3 components per vertex</span></a>
<a class="sourceLine" id="cb1-121" title="121">    gl_FLOAT <span class="co">-- coord type</span></a>
<a class="sourceLine" id="cb1-122" title="122">    (fromBool <span class="dt">False</span>) <span class="co">-- normalize?</span></a>
<a class="sourceLine" id="cb1-123" title="123">    <span class="dv">0</span> <span class="co">-- stride</span></a>
<a class="sourceLine" id="cb1-124" title="124">    nullPtr <span class="co">-- vertex buffer offset</span></a>
<a class="sourceLine" id="cb1-125" title="125"></a>
<a class="sourceLine" id="cb1-126" title="126"><span class="ot">loadProgram ::</span> (<span class="dt">String</span>, <span class="dt">String</span>) <span class="ot">-&gt;</span> (<span class="dt">String</span>, <span class="dt">String</span>) <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">GLuint</span></a>
<a class="sourceLine" id="cb1-127" title="127">loadProgram vertShader fragShader <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-128" title="128">  shaderIds <span class="ot">&lt;-</span> <span class="fu">mapM</span> (<span class="fu">uncurry</span> loadShader)</a>
<a class="sourceLine" id="cb1-129" title="129">    [ (gl_VERTEX_SHADER, vertShader)</a>
<a class="sourceLine" id="cb1-130" title="130">    , (gl_FRAGMENT_SHADER, fragShader)</a>
<a class="sourceLine" id="cb1-131" title="131">    ]</a>
<a class="sourceLine" id="cb1-132" title="132">  progId <span class="ot">&lt;-</span> glCreateProgram</a>
<a class="sourceLine" id="cb1-133" title="133">  <span class="fu">putStrLn</span> <span class="st">&quot;Linking program&quot;</span></a>
<a class="sourceLine" id="cb1-134" title="134">  <span class="fu">mapM_</span> (glAttachShader progId) shaderIds</a>
<a class="sourceLine" id="cb1-135" title="135">  glLinkProgram progId</a>
<a class="sourceLine" id="cb1-136" title="136">  _ <span class="ot">&lt;-</span> checkStatus</a>
<a class="sourceLine" id="cb1-137" title="137">    gl_LINK_STATUS glGetProgramiv glGetProgramInfoLog progId</a>
<a class="sourceLine" id="cb1-138" title="138">  <span class="fu">mapM_</span> glDeleteShader shaderIds</a>
<a class="sourceLine" id="cb1-139" title="139">  <span class="fu">return</span> progId</a>
<a class="sourceLine" id="cb1-140" title="140"></a>
<a class="sourceLine" id="cb1-141" title="141"><span class="ot">loadShader ::</span> <span class="dt">GLenum</span> <span class="ot">-&gt;</span> (<span class="dt">String</span>, <span class="dt">String</span>) <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">GLuint</span></a>
<a class="sourceLine" id="cb1-142" title="142">loadShader shaderTypeFlag (name, code) <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-143" title="143">  shaderId <span class="ot">&lt;-</span> glCreateShader shaderTypeFlag</a>
<a class="sourceLine" id="cb1-144" title="144">  withCString code <span class="fu">$</span> \codePtr <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb1-145" title="145">    with codePtr <span class="fu">$</span> \codePtrPtr <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb1-146" title="146">      glShaderSource shaderId <span class="dv">1</span> codePtrPtr nullPtr</a>
<a class="sourceLine" id="cb1-147" title="147">  <span class="fu">putStrLn</span> <span class="fu">$</span> <span class="st">&quot;Compiling shader `&quot;</span> <span class="fu">++</span> name <span class="fu">++</span> <span class="st">&quot;'&quot;</span></a>
<a class="sourceLine" id="cb1-148" title="148">  glCompileShader shaderId</a>
<a class="sourceLine" id="cb1-149" title="149">  _ <span class="ot">&lt;-</span> checkStatus</a>
<a class="sourceLine" id="cb1-150" title="150">    gl_COMPILE_STATUS glGetShaderiv glGetShaderInfoLog shaderId</a>
<a class="sourceLine" id="cb1-151" title="151">  <span class="fu">return</span> shaderId</a>
<a class="sourceLine" id="cb1-152" title="152"></a>
<a class="sourceLine" id="cb1-153" title="153"><span class="ot">checkStatus ::</span> (<span class="dt">Integral</span> a1, <span class="dt">Storable</span> a1)</a>
<a class="sourceLine" id="cb1-154" title="154">  <span class="ot">=&gt;</span> <span class="dt">GLenum</span></a>
<a class="sourceLine" id="cb1-155" title="155">  <span class="ot">-&gt;</span> (t <span class="ot">-&gt;</span> <span class="dt">GLenum</span> <span class="ot">-&gt;</span> <span class="dt">Ptr</span> a1 <span class="ot">-&gt;</span> <span class="dt">IO</span> a)</a>
<a class="sourceLine" id="cb1-156" title="156">  <span class="ot">-&gt;</span> (t <span class="ot">-&gt;</span> a1 <span class="ot">-&gt;</span> <span class="dt">Ptr</span> a3 <span class="ot">-&gt;</span> <span class="dt">Ptr</span> <span class="dt">Foreign.C.Types.CChar</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> a2)</a>
<a class="sourceLine" id="cb1-157" title="157">  <span class="ot">-&gt;</span> t</a>
<a class="sourceLine" id="cb1-158" title="158">  <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">Bool</span></a>
<a class="sourceLine" id="cb1-159" title="159">checkStatus statusFlag glGetFn glInfoLogFn componentId <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-160" title="160">  <span class="kw">let</span></a>
<a class="sourceLine" id="cb1-161" title="161">    fetch info <span class="fu">=</span> withNewPtr (glGetFn componentId info)</a>
<a class="sourceLine" id="cb1-162" title="162">  status <span class="ot">&lt;-</span> liftM toBool <span class="fu">$</span> fetch statusFlag</a>
<a class="sourceLine" id="cb1-163" title="163">  logLength <span class="ot">&lt;-</span> fetch gl_INFO_LOG_LENGTH</a>
<a class="sourceLine" id="cb1-164" title="164">  when (logLength <span class="fu">&gt;</span> <span class="dv">0</span>) <span class="fu">$</span></a>
<a class="sourceLine" id="cb1-165" title="165">    allocaArray0 (<span class="fu">fromIntegral</span> logLength) <span class="fu">$</span> \msgPtr <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-166" title="166">      _ <span class="ot">&lt;-</span> glInfoLogFn componentId logLength nullPtr msgPtr</a>
<a class="sourceLine" id="cb1-167" title="167">      msg <span class="ot">&lt;-</span> peekCString msgPtr</a>
<a class="sourceLine" id="cb1-168" title="168">      (<span class="kw">if</span> status <span class="kw">then</span> <span class="fu">putStrLn</span> <span class="kw">else</span> <span class="fu">fail</span>) msg</a>
<a class="sourceLine" id="cb1-169" title="169">  <span class="fu">return</span> status</a>
<a class="sourceLine" id="cb1-170" title="170"></a>
<a class="sourceLine" id="cb1-171" title="171"><span class="ot">fragmentShader2 ::</span> <span class="dt">String</span></a>
<a class="sourceLine" id="cb1-172" title="172">fragmentShader2 <span class="fu">=</span> <span class="fu">unlines</span></a>
<a class="sourceLine" id="cb1-173" title="173">  [ <span class="st">&quot;#version 330 core&quot;</span></a>
<a class="sourceLine" id="cb1-174" title="174">  , <span class="st">&quot;in vec3 fragmentColor;&quot;</span></a>
<a class="sourceLine" id="cb1-175" title="175">  , <span class="st">&quot;out vec3 finalColor;&quot;</span></a>
<a class="sourceLine" id="cb1-176" title="176">  , <span class="st">&quot;void main()&quot;</span></a>
<a class="sourceLine" id="cb1-177" title="177">  , <span class="st">&quot;{&quot;</span></a>
<a class="sourceLine" id="cb1-178" title="178">    , <span class="st">&quot;finalColor= fragmentColor;&quot;</span></a>
<a class="sourceLine" id="cb1-179" title="179">  , <span class="st">&quot;}&quot;</span></a>
<a class="sourceLine" id="cb1-180" title="180">  ]</a>
<a class="sourceLine" id="cb1-181" title="181"></a>
<a class="sourceLine" id="cb1-182" title="182"><span class="ot">vertexShader2 ::</span> <span class="dt">String</span></a>
<a class="sourceLine" id="cb1-183" title="183">vertexShader2 <span class="fu">=</span> <span class="fu">unlines</span></a>
<a class="sourceLine" id="cb1-184" title="184">  [ <span class="st">&quot;#version 330 core&quot;</span></a>
<a class="sourceLine" id="cb1-185" title="185">  <span class="co">-- Input vertex data, different for all executions of this shader.</span></a>
<a class="sourceLine" id="cb1-186" title="186">  , <span class="st">&quot;in vec3 vertexPosition_modelspace;&quot;</span></a>
<a class="sourceLine" id="cb1-187" title="187">  , <span class="st">&quot;in vec3 vertexColor;&quot;</span></a>
<a class="sourceLine" id="cb1-188" title="188">  <span class="co">-- Values that stay constant for the whole mesh</span></a>
<a class="sourceLine" id="cb1-189" title="189">  , <span class="st">&quot;uniform mat4 MVP;&quot;</span></a>
<a class="sourceLine" id="cb1-190" title="190">  , <span class="st">&quot;out vec3 fragmentColor;&quot;</span></a>
<a class="sourceLine" id="cb1-191" title="191">  , <span class="st">&quot;void main()&quot;</span></a>
<a class="sourceLine" id="cb1-192" title="192">  , <span class="st">&quot;{&quot;</span></a>
<a class="sourceLine" id="cb1-193" title="193">    , <span class="st">&quot;fragmentColor = vertexColor;&quot;</span></a>
<a class="sourceLine" id="cb1-194" title="194">    , <span class="st">&quot;vec4 v = vec4(vertexPosition_modelspace, 1);&quot;</span></a>
<a class="sourceLine" id="cb1-195" title="195">    , <span class="st">&quot;gl_Position = MVP * v;&quot;</span></a>
<a class="sourceLine" id="cb1-196" title="196">  , <span class="st">&quot;}&quot;</span></a>
<a class="sourceLine" id="cb1-197" title="197">  ]</a>
<a class="sourceLine" id="cb1-198" title="198"></a>
<a class="sourceLine" id="cb1-199" title="199"><span class="ot">main ::</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb1-200" title="200">main <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-201" title="201">  win <span class="ot">&lt;-</span> initialize</a>
<a class="sourceLine" id="cb1-202" title="202">  glids <span class="ot">&lt;-</span> initializeGL</a>
<a class="sourceLine" id="cb1-203" title="203">  inputLoop win glids</a>
<a class="sourceLine" id="cb1-204" title="204">  freeResources glids</a>
<a class="sourceLine" id="cb1-205" title="205">  GLFW.terminate</a>
<a class="sourceLine" id="cb1-206" title="206">  <span class="fu">return</span> ()</a>
<a class="sourceLine" id="cb1-207" title="207"></a>
<a class="sourceLine" id="cb1-208" title="208"><span class="ot">inputLoop ::</span> <span class="dt">GLFW.Window</span> <span class="ot">-&gt;</span> <span class="dt">GLIDs</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb1-209" title="209">inputLoop win glids <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-210" title="210">  drawStuff glids</a>
<a class="sourceLine" id="cb1-211" title="211">  GLFW.swapBuffers win</a>
<a class="sourceLine" id="cb1-212" title="212">  GLFW.pollEvents</a>
<a class="sourceLine" id="cb1-213" title="213">  keyState <span class="ot">&lt;-</span> GLFW.getKey win <span class="dt">GLFW.Key'Escape</span></a>
<a class="sourceLine" id="cb1-214" title="214">  closeWindow <span class="ot">&lt;-</span> GLFW.windowShouldClose win</a>
<a class="sourceLine" id="cb1-215" title="215">  when (keyState <span class="fu">/=</span> <span class="dt">GLFW.KeyState'Pressed</span> <span class="fu">&amp;&amp;</span> closeWindow <span class="fu">==</span> <span class="dt">False</span>) <span class="fu">$</span></a>
<a class="sourceLine" id="cb1-216" title="216">    inputLoop win glids</a>
<a class="sourceLine" id="cb1-217" title="217"></a>
<a class="sourceLine" id="cb1-218" title="218"><span class="ot">drawStuff ::</span> <span class="dt">GLIDs</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb1-219" title="219">drawStuff <span class="dt">GLIDs</span>{<span class="fu">..</span>} <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-220" title="220">  glClear gl_COLOR_BUFFER_BIT</a>
<a class="sourceLine" id="cb1-221" title="221">  glClear gl_DEPTH_BUFFER_BIT</a>
<a class="sourceLine" id="cb1-222" title="222">  glUseProgram progId</a>
<a class="sourceLine" id="cb1-223" title="223">  <span class="co">-- the (fromBool True) is because we are ROW-first (Data.Vec)</span></a>
<a class="sourceLine" id="cb1-224" title="224">  with mvpMatrix</a>
<a class="sourceLine" id="cb1-225" title="225">    <span class="fu">$</span> glUniformMatrix4fv mvpMatrixUniform <span class="dv">1</span> (fromBool <span class="dt">True</span>)</a>
<a class="sourceLine" id="cb1-226" title="226">    <span class="fu">.</span> castPtr</a>
<a class="sourceLine" id="cb1-227" title="227">  bindBufferToAttrib vertexBufferId vertexAttrib</a>
<a class="sourceLine" id="cb1-228" title="228">  bindBufferToAttrib colorBufferId colorAttrib</a>
<a class="sourceLine" id="cb1-229" title="229">  glDrawArrays gl_TRIANGLES <span class="dv">0</span> <span class="dv">3</span></a>
<a class="sourceLine" id="cb1-230" title="230">  glDisableVertexAttribArray colorAttrib</a>
<a class="sourceLine" id="cb1-231" title="231">  glDisableVertexAttribArray vertexAttrib</a>
<a class="sourceLine" id="cb1-232" title="232"></a>
<a class="sourceLine" id="cb1-233" title="233"><span class="co">-- Some higher-order math helper functions. Depending on what math</span></a>
<a class="sourceLine" id="cb1-234" title="234"><span class="co">-- library you use, you'd use the functions that comes with that</span></a>
<a class="sourceLine" id="cb1-235" title="235"><span class="co">-- library. The functions here are from the Data.Vec package.</span></a>
<a class="sourceLine" id="cb1-236" title="236"><span class="ot">vec3 ::</span> <span class="kw">forall</span> a a1 a2<span class="fu">.</span> a <span class="ot">-&gt;</span> a1 <span class="ot">-&gt;</span> a2 <span class="ot">-&gt;</span> a <span class="fu">:.</span> (a1 <span class="fu">:.</span> (a2 <span class="fu">:.</span> ()))</a>
<a class="sourceLine" id="cb1-237" title="237">vec3 x y z <span class="fu">=</span> x <span class="fu">:.</span> y <span class="fu">:.</span> z<span class="fu">:.</span> ()</a>
<a class="sourceLine" id="cb1-238" title="238"></a>
<a class="sourceLine" id="cb1-239" title="239"><span class="ot">mvpMatrix ::</span> <span class="dt">Mat44</span> <span class="dt">GLfloat</span></a>
<a class="sourceLine" id="cb1-240" title="240">mvpMatrix <span class="fu">=</span> multmm (multmm projection view) model</a>
<a class="sourceLine" id="cb1-241" title="241">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb1-242" title="242">  projection <span class="fu">=</span> perspective <span class="fl">0.1</span> <span class="dv">100</span> (<span class="fu">pi/</span><span class="dv">4</span>) (<span class="dv">4</span><span class="fu">/</span><span class="dv">3</span>)</a>
<a class="sourceLine" id="cb1-243" title="243">  view <span class="fu">=</span> lookAt (vec3 <span class="dv">4</span> <span class="dv">3</span> <span class="dv">3</span>) (vec3 <span class="dv">0</span> <span class="dv">0</span> <span class="dv">0</span>) (vec3 <span class="dv">0</span> <span class="dv">1</span> <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb1-244" title="244">  model <span class="fu">=</span> identity</a>
<a class="sourceLine" id="cb1-245" title="245"></a>
<a class="sourceLine" id="cb1-246" title="246"><span class="co">-- The closest relative to this function is Data.Vec's `rotationLookAt`. We just</span></a>
<a class="sourceLine" id="cb1-247" title="247"><span class="co">-- mirror the code found in the GLM library (glm.g-truc.net). An additional</span></a>
<a class="sourceLine" id="cb1-248" title="248"><span class="co">-- resource is Jeremiah van Oosten's &quot;Understanding the View Matrix&quot;, found at</span></a>
<a class="sourceLine" id="cb1-249" title="249"><span class="co">-- http://3dgep.com/?p=1700.</span></a>
<a class="sourceLine" id="cb1-250" title="250"><span class="ot">lookAt ::</span> <span class="dt">Floating</span> a <span class="ot">=&gt;</span> <span class="dt">Vec3</span> a <span class="ot">-&gt;</span> <span class="dt">Vec3</span> a <span class="ot">-&gt;</span> <span class="dt">Vec3</span> a <span class="ot">-&gt;</span> <span class="dt">Mat44</span> a</a>
<a class="sourceLine" id="cb1-251" title="251">lookAt eye target up <span class="fu">=</span> x <span class="fu">:.</span> y <span class="fu">:.</span> z <span class="fu">:.</span> h <span class="fu">:.</span> ()</a>
<a class="sourceLine" id="cb1-252" title="252">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb1-253" title="253">  forward <span class="fu">=</span> normalize <span class="fu">$</span> target <span class="fu">-</span> eye</a>
<a class="sourceLine" id="cb1-254" title="254">  right <span class="fu">=</span> normalize <span class="fu">$</span> cross forward up</a>
<a class="sourceLine" id="cb1-255" title="255">  up' <span class="fu">=</span> cross right forward</a>
<a class="sourceLine" id="cb1-256" title="256">  x <span class="fu">=</span> snoc right (<span class="fu">-</span>(dot right eye))</a>
<a class="sourceLine" id="cb1-257" title="257">  y <span class="fu">=</span> snoc up' (<span class="fu">-</span>(dot up' eye))</a>
<a class="sourceLine" id="cb1-258" title="258">  z <span class="fu">=</span> snoc (<span class="fu">-</span>forward) (dot forward eye)</a>
<a class="sourceLine" id="cb1-259" title="259">  h <span class="fu">=</span> <span class="dv">0</span> <span class="fu">:.</span> <span class="dv">0</span> <span class="fu">:.</span> <span class="dv">0</span> <span class="fu">:.</span> <span class="dv">1</span> <span class="fu">:.</span> ()</a></code></pre></div>
</div>

		</div>
		<div id="footer">
			<p>Copyright (C) 2013-2018 Linus Arver. All rights reserved.</p>
			<a href="https://github.com/listx/listx_blog">Site</a>
			<a href="https://github.com/listx/listx.github.io">generated</a>
			with
			<a href="https://jaspervdj.be/hakyll">Hakyll</a>
			and
			<a href="http://sebastiaanvisser.github.com/clay">Clay</a>.
			<br>
			<a href="../atom.xml">Atom feed</a>
		</div>
	</body>
</html>
