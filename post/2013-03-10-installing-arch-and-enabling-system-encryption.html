<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>Linus's Blog - Installing Arch Linux and Enabling System Encryption</title>
		<link rel="stylesheet" href="../css/base.css">
		<link rel="stylesheet" href="../css/syntax.css">
		<link href="http://fonts.googleapis.com/css?family=Merriweather:400,400italic,700italic,700" rel="stylesheet" type="text/css">
		<link rel="shortcut icon" type="image/png" href="../favicon.png">
		
	</head>
	<body>
		<div id="header">
			<a href="../">Home</a>
			&bull;
			<a href="../about.html">About</a>
			&bull;
			<a href="../code.html">Code</a>
			&bull;
			<a href="../archive.html">Archive</a>
		</div>

		<div id="content">
			<h1 class="center">Installing Arch Linux and Enabling System Encryption</h1>

			<div class="info center"><code>2013-03-10</code></div>
<div class="info center"><a href="../tag/linux.html">linux</a>, <a href="../tag/arch.html">arch</a></div>

<p>The follow list of commands is what you need to execute in order to set up Arch Linux with system-level encryption. The setup is 1 hard drive with 1 100MiB <code>/boot</code> partition, with the rest as a single LVM partition that will contain the <code>/</code> root, <code>/home</code>, and <code>swap</code> partitions. This LVM partition will be encrypted so that when the system boots, it will require a password to unlock the <code>/</code>, <code>/home</code>, and <code>swap</code> partitions to boot up the system. The <code>/boot</code> partition will remain unencrypted for the sake of simplicity.</p>
<p>If you are wondering why the <code>/home</code> partition is mounted on <code>/mnt/home</code> in some of the commands, this is because the Arch Linux live CD environment will load up a temporary Linux system onto your RAM, and we use the <code>/mnt</code> directory (again all files/folders are temporarily in your RAM) to mount the hard drive partitions. You can always use a live CD anywhere to load up a barebone Linux system to your RAM and mount the hard drives on your computer for inspection, and in such a case you will again use the <code>/mnt</code> directory to mount your hard drives here.</p>
<p>If you want to look up the manpages for these commands, use <code>ALT+F2</code>, <code>ALT+F3</code>, etc. to log into and switch between independent TTY screens.</p>
<p>Be sure to wipe the drive with</p>
<pre><code>dd if=/dev/urandom of=/dev/sdX</code></pre>
<p>before doing anything. This way, your new Linux install will blend into the random noise data resulting from the command above, making it virtually impossible to detect which portions of the drive contain actual data. If the disk you want to wipe is a secondary device to an existing Linux installation, you can try using <a href="../../code.html#floop"><code>floop</code></a> to generate a faster stream of pseudorandom bytes. With <code>floop</code>, you can just do</p>
<pre><code>floop --threads 4 --thread-buf 0x200000 --count 0 | dd of=/dev/sdX</code></pre>
<p>and it will be significantly faster than using <code>/dev/urandom</code>.</p>
<table class="sourceCode bash numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
</pre></td><td class="sourceCode"><pre><code class="sourceCode bash"><span class="co"># Put in the Arch Linux live CD and run the following commands...</span>

<span class="co"># Set up 2 partitions; the first one is the boot 100MB partition (be sure</span>
<span class="co"># to toggle the BOOT flag on it), and the second will be the LVM partition.</span>
<span class="co"># Be sure to select 8E for the LVM partition! You can use</span>
<span class="co"># /dev/disk/by-uuid/XXXX for more fine-grained control; use &quot;blkid -o list&quot;</span>
<span class="co"># to find out which drives are given which UUIDs.</span>

<span class="kw">cfdisk</span> /dev/sda

<span class="co"># Now set up encryption on the LVM partition (the 2nd partition, so it's</span>
<span class="co"># /dev/sda2). It is recommended to use aes-xts-plain64 if the partition is</span>
<span class="co"># larger than 2 TB, I think.</span>

<span class="kw">cryptsetup</span> -c aes-xts-plain -y -s 512 luksFormat /dev/sda2

<span class="co"># Decrypt the encrypted partition with LUKS. We need to decrypt it first</span>
<span class="co"># before setting up LVM volumes and filesystems on it. This will create</span>
<span class="co"># an entry under /dev/mapper/luks.</span>

<span class="kw">cryptsetup</span> luksOpen /dev/sda2 luks

<span class="co"># Set up LVM. We call our volume group &quot;vg0&quot;. To be honest I am not sure if</span>
<span class="co"># the &quot;--contiguous y&quot; option for swap matters because we are encrypting it</span>
<span class="co"># (doesn't block encryption encrypt data randomly on the disk?), but that's</span>
<span class="co"># what I found online and that's what I'll use here. The &quot;+100%FREE&quot; option</span>
<span class="co"># is a very handy option that tells LVM to fill up all remaining free space,</span>
<span class="co"># in this case, for the &quot;home&quot; logical volume.</span>
<span class="co"># Read more about LVM on your favorite online wiki.</span>

<span class="kw">pvcreate</span> /dev/mapper/luks
<span class="kw">vgcreate</span> vg0 /dev/mapper/luks
<span class="kw">lvcreate</span> --size 40G vg0 --name root
<span class="kw">lvcreate</span> --size 2G --contiguous y vg0 --name swap
<span class="kw">lvcreate</span> -l +100%FREE vg0 --name home

<span class="co"># Initialize filesystems. Btrfs is still experimental, so I choose ext4</span>
<span class="co"># here. The vg0-root, vg0-home, and vg0-swap volumes should</span>
<span class="co"># appear under /dev/mapper as you create them with the lvcreate command.</span>

<span class="kw">mkfs.ext4</span> /dev/sda1 <span class="co"># the boot partition</span>
<span class="kw">mkfs.ext4</span> /dev/mapper/vg0-root
<span class="kw">mkfs.ext4</span> /dev/mapper/vg0-home
<span class="kw">mkswap</span> /dev/mapper/vg0-swap

<span class="co"># Mount the logical volumes. Why? Because we need to install Arch Linux onto</span>
<span class="co"># it! You probably don't need to mount the &quot;home&quot; volume but it couldn't</span>
<span class="co"># hurt. Besides, it's nice to test that all volumes can be mounted OK anyway.</span>
<span class="co">#</span>
<span class="co"># NOTE: Mount order is important! YOU MUST FIRST MOUNT THE ROOT PARTITION into</span>
<span class="co"># /mnt before creating more directories such as /mnt/boot, /mnt/home, etc. to</span>
<span class="co"># mount the /boot, /home, and any other partitions.</span>

<span class="kw">mount</span> /dev/mapper/vg0-root /mnt <span class="co"># /mnt is our system's &quot;/&quot; root   directory</span>

<span class="kw">mkdir</span> /mnt/boot
<span class="kw">mount</span> /dev/sda1 /mnt/boot

<span class="kw">mkdir</span> /mnt/home
<span class="kw">mount</span> /dev/mapper/vg0-home /mnt/home

<span class="kw">swapon</span> /dev/mapper/vg0-swap

<span class="co"># Set up package download mirrors. The kernel mirror is generally a good one</span>
<span class="co"># if you live in the US. Google &quot;arch linux mirror status&quot; to find the</span>
<span class="co"># fastest mirrors.</span>

<span class="kw">vi</span> /etc/pacman.d/mirrorlist

<span class="co"># Download and install the core minimum packages to get a working Linux</span>
<span class="co"># terminal (console) environment. Ah, simplicity!</span>

<span class="kw">pacstrap</span> -i /mnt base base-devel

<span class="co"># Generate and inspect the filesystem tables needed when the system first</span>
<span class="co"># starts. The file should contain four &quot;partitions&quot; (I put them in quotes</span>
<span class="co"># because remember, we are using only 2 real partitions; 1st one is /boot and</span>
<span class="co"># the 2nd one is our LVM containing /, /home, and swap).</span>

<span class="kw">genfstab</span> -U -p /mnt <span class="kw">&gt;&gt;</span> /mnt/etc/fstab
<span class="kw">vi</span> /mnt/etc/fstab

<span class="co"># Make the system pretend that /mnt is /. This is called &quot;chrooting&quot;. We need</span>
<span class="co"># to do this because some of the commands like locale-gen, systemctl, etc.</span>
<span class="co"># read configuration files from /etc, for example, and right now our /etc is</span>
<span class="co"># the /etc used by the Arch Linux live CD, not our newly-installed system's</span>
<span class="co"># root directory, /mnt.</span>

<span class="kw">arch-chroot</span> /mnt /bin/bash

<span class="co"># Choose and generate locale; programs supporting internationalization (aka</span>
<span class="co"># &quot;i18n&quot;) will use the language you pick to generate the proper text used in</span>
<span class="co"># menus, error messages, etc. Just choose &quot;en_US.UTF-8 UTF-8&quot; if you live in</span>
<span class="co"># the US.</span>

<span class="kw">vi</span> /etc/locale.gen
<span class="kw">locale-gen</span>
<span class="kw">echo</span> LANG=en_US.UTF-8 <span class="kw">&gt;</span> /etc/locale.conf

<span class="co"># Choose default font used by the virtual console (the terminal screen you</span>
<span class="co"># will see when you first boot up your new Arch Linux system).</span>

<span class="kw">setfont</span> Lat2-Terminus16
<span class="kw">echo</span> FONT=Lat2-Terminus16 <span class="kw">&gt;</span> /etc/vconsole.conf

<span class="co"># Choose timezone. Here, we tell hwclock that we want the hardware clock on</span>
<span class="co"># the motherboard to be set to UTC, which will then be interpreted as UTC</span>
<span class="co"># time by the kernel and re-adjusted to the timezone you chose when you</span>
<span class="co"># actually use the system. This is nice because UTC is the &quot;master&quot; time the</span>
<span class="co"># world uses anyway, so it makes sense to tell your motherboard to use it.</span>

<span class="kw">ln</span> -s /usr/share/zoneinfo/America/Los_Angeles /etc/localtime
<span class="kw">hwclock</span> --systohc --utc

<span class="co"># Choose your computer's name. Keep it simple, without spaces. I use &quot;k0&quot;.</span>

<span class="kw">echo</span> MYHOSTNAME <span class="kw">&gt;</span> /etc/hostname

<span class="co"># Enable DHCPCD... aka &quot;acquire dynamic ip address from your router/switch&quot;.  Be</span>
<span class="co"># sure to choose the right device name (typically eth0 or eth1 (eth2, if you</span>
<span class="co"># have 3 ethernet ports)); you can find out the correct device name with `ip</span>
<span class="co"># link` (look for the device under the first entry, `lo`.). If you choose the</span>
<span class="co"># wrong &quot;eth&quot; number, just go to /etc/systemd/system/multi-user.target.wants/</span>
<span class="co"># and rename the symlink; e.g., rename</span>
<span class="co"># /etc/systemd/system/multi-user.target.wants/dhcpcd@eth0.service to</span>
<span class="co"># /etc/systemd/system/multi-user.target.wants/dhcpcd@eth1.service.</span>

<span class="kw">systemctl</span> enable dhcpcd@DEVICENAME.service

<span class="co"># Disable unused package repos. You will want to disable the [testing] repo</span>
<span class="co"># unless you want to test unstable packages and engage in the package</span>
<span class="co"># debugging/development process. For Haskellers, be sure to add the</span>
<span class="co"># [haskell-core] repo (see</span>
<span class="co"># https://wiki.archlinux.org/index.php/Haskell_Package_Guidelines).</span>

<span class="kw">vi</span> /etc/pacman.conf

<span class="co"># Set up the root user (&quot;administrator&quot; for you Windows people) password.</span>

<span class="kw">passwd</span>

<span class="co"># Install zsh, because you will like it better any other shell out there.</span>

<span class="kw">pacman</span> -S zsh

<span class="co"># Add your regular user, and set up your password. This is your normal</span>
<span class="co"># username. We use the &quot;-s /bin/zsh&quot; option to tell useradd that we want to</span>
<span class="co"># log in with zsh.</span>
<span class="co">#</span>
<span class="co"># If you want, you can add a new group that will only have your username as its</span>
<span class="co"># only &quot;member&quot;, with `groupadd -g 1000 MYGROUPNAME`, and then you can use this</span>
<span class="co"># group name for the `-g` flag's argument in the `useradd` command below. I like</span>
<span class="co"># to have 1-character usernames for my machines to keep things simple and short,</span>
<span class="co"># as I will be the exclusive user of the system anyway, so I also use the same</span>
<span class="co"># character for my group as well, so that, in particular, the `ls` command's</span>
<span class="co"># full listing of my files looks very succinct, as I like to live in the</span>
<span class="co"># terminal and use `ls` daily.</span>

<span class="kw">useradd</span> -m -g users -G wheel,storage,power -s /bin/zsh MYUSERNAME
<span class="kw">passwd</span> MYUSERNAME

<span class="co"># VERY IMPORTANT: Add in the filesystem type that /root partition (LVM) is</span>
<span class="co"># using (for this tutorial, it is &quot;ext4&quot;) into the MODULES variable and also</span>
<span class="co"># add 'encrypt' and 'lvm2' into HOOKS.</span>

<span class="kw">vi</span> /etc/mkinitcpio.conf

<span class="co"># Re-generate the linux image to take into account the LVM and encrypt</span>
<span class="co"># flags we added into /etc/mkinitcpio.conf. I say &quot;re-generate&quot; because this</span>
<span class="co"># is our second time doing this (the first time was when we installed the</span>
<span class="co"># linux package with the pacstrap command above).</span>

<span class="kw">mkinitcpio</span> -p linux

<span class="co"># Install boot loader. I like SYSLINUX because of the saner/easier-looking boot</span>
<span class="co"># configuration file, compared to GRUB 2. Be sure to add in (as a single line)</span>
<span class="co">#     &quot;APPEND cryptdevice=/dev/disk/by-uuid/xxxxxxxxxx:luks</span>
<span class="co">#           root=/dev/mapper/vg0-root resume=/dev/mapper/vg0-swap ro&quot;</span>
<span class="co"># under the &quot;LABEL arch&quot; entries, so that SYSLINUX tells the kernel to look for</span>
<span class="co"># the encrypted LVM partition. Otherwise, your system won't boot! Don't forget</span>
<span class="co"># to actually look up the UUID of your LVM partition (/dev/sda2 in this</span>
<span class="co"># tutorial). To easily add in the long UUID of the disk, just concatenate it</span>
<span class="co"># into the syslinux.cfg file with `blkid -o list &gt;&gt;</span>
<span class="co"># /boot/syslinux/syslinux.cfg`, and edit as needed.</span>
<span class="co">#</span>
<span class="co"># You don't need to tell the kernel about your vg0-home volume because that will</span>
<span class="co"># get mounted by /etc/fstab when it is read later in the boot process.</span>

<span class="kw">pacman</span> -S syslinux
<span class="kw">syslinux-install_update</span> -i -a -m
<span class="kw">vi</span> /boot/syslinux/syslinux.cfg

<span class="co"># Exit chroot environment.</span>

<span class="kw">exit</span>

<span class="co"># Unmount volumes, and reboot. Remove your Arch Linux live CD when your</span>
<span class="co"># computer powers on again.</span>

<span class="kw">umount</span> /mnt/boot
<span class="kw">umount</span> /mnt/home
<span class="kw">umount</span> /mnt
<span class="kw">swapoff</span>
<span class="kw">reboot</span></code></pre></td></tr></table>

		</div>
		<div id="footer">
			<a href="https://github.com/listx/listx.github.io">Site</a>
			<a href="https://github.com/listx/listx_blog">generated</a>
			with
			<a href="http://jaspervdj.be/hakyll">Hakyll</a>
			and
			<a href="http://sebastiaanvisser.github.com/clay">Clay</a>.
		</div>
	</body>
</html>
